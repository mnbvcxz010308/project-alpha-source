<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Vipin G S">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Jupyter Hub on Kubernetes Part II: NFS | EssentialDataScience</title>

        <link rel="alternate" type="application/atom+xml" title="EssentialDataScience blog atom feed" href="/feeds/all.atom.xml" />
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <style>.codehilite .hll { background-color: #404040 }
.codehilite .c { color: #999999; font-style: italic } /* Comment */
.codehilite .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.codehilite .g { color: #d0d0d0 } /* Generic */
.codehilite .k { color: #6ab825; font-weight: bold } /* Keyword */
.codehilite .l { color: #d0d0d0 } /* Literal */
.codehilite .n { color: #d0d0d0 } /* Name */
.codehilite .o { color: #d0d0d0 } /* Operator */
.codehilite .x { color: #d0d0d0 } /* Other */
.codehilite .p { color: #d0d0d0 } /* Punctuation */
.codehilite .cm { color: #999999; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #cd2828; font-weight: bold } /* Comment.Preproc */
.codehilite .c1 { color: #999999; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #e50808; font-weight: bold; background-color: #520000 } /* Comment.Special */
.codehilite .gd { color: #d22323 } /* Generic.Deleted */
.codehilite .ge { color: #d0d0d0; font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #d22323 } /* Generic.Error */
.codehilite .gh { color: #ffffff; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #589819 } /* Generic.Inserted */
.codehilite .go { color: #cccccc } /* Generic.Output */
.codehilite .gp { color: #aaaaaa } /* Generic.Prompt */
.codehilite .gs { color: #d0d0d0; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #ffffff; text-decoration: underline } /* Generic.Subheading */
.codehilite .gt { color: #d22323 } /* Generic.Traceback */
.codehilite .kc { color: #6ab825; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #6ab825; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #6ab825; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #6ab825 } /* Keyword.Pseudo */
.codehilite .kr { color: #6ab825; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #6ab825; font-weight: bold } /* Keyword.Type */
.codehilite .ld { color: #d0d0d0 } /* Literal.Date */
.codehilite .m { color: #3677a9 } /* Literal.Number */
.codehilite .s { color: #ed9d13 } /* Literal.String */
.codehilite .na { color: #bbbbbb } /* Name.Attribute */
.codehilite .nb { color: #24909d } /* Name.Builtin */
.codehilite .nc { color: #447fcf; text-decoration: underline } /* Name.Class */
.codehilite .no { color: #40ffff } /* Name.Constant */
.codehilite .nd { color: #ffa500 } /* Name.Decorator */
.codehilite .ni { color: #d0d0d0 } /* Name.Entity */
.codehilite .ne { color: #bbbbbb } /* Name.Exception */
.codehilite .nf { color: #447fcf } /* Name.Function */
.codehilite .nl { color: #d0d0d0 } /* Name.Label */
.codehilite .nn { color: #447fcf; text-decoration: underline } /* Name.Namespace */
.codehilite .nx { color: #d0d0d0 } /* Name.Other */
.codehilite .py { color: #d0d0d0 } /* Name.Property */
.codehilite .nt { color: #6ab825; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #40ffff } /* Name.Variable */
.codehilite .ow { color: #6ab825; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #666666 } /* Text.Whitespace */
.codehilite .mf { color: #3677a9 } /* Literal.Number.Float */
.codehilite .mh { color: #3677a9 } /* Literal.Number.Hex */
.codehilite .mi { color: #3677a9 } /* Literal.Number.Integer */
.codehilite .mo { color: #3677a9 } /* Literal.Number.Oct */
.codehilite .sb { color: #ed9d13 } /* Literal.String.Backtick */
.codehilite .sc { color: #ed9d13 } /* Literal.String.Char */
.codehilite .sd { color: #ed9d13 } /* Literal.String.Doc */
.codehilite .s2 { color: #ed9d13 } /* Literal.String.Double */
.codehilite .se { color: #ed9d13 } /* Literal.String.Escape */
.codehilite .sh { color: #ed9d13 } /* Literal.String.Heredoc */
.codehilite .si { color: #ed9d13 } /* Literal.String.Interpol */
.codehilite .sx { color: #ffa500 } /* Literal.String.Other */
.codehilite .sr { color: #ed9d13 } /* Literal.String.Regex */
.codehilite .s1 { color: #ed9d13 } /* Literal.String.Single */
.codehilite .ss { color: #ed9d13 } /* Literal.String.Symbol */
.codehilite .bp { color: #24909d } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #40ffff } /* Name.Variable.Class */
.codehilite .vg { color: #40ffff } /* Name.Variable.Global */
.codehilite .vi { color: #40ffff } /* Name.Variable.Instance */
.codehilite .il { color: #3677a9 } /* Literal.Number.Integer.Long */</style>
        <style>body{margin:0;padding:0;font:15px 'Source Sans Pro',sans-serif;line-height:1.6em;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}a{color:#007ee5;text-decoration:none}a:hover{color:#007ee5;text-decoration:none}header.main-header{background:none repeat scroll 0% 0% #2A66C0;margin-bottom:0px}header.main-header a{color:#fff}header.main-header .container{max-width:1000px}header.main-header .container nav a:hover{background-color:#2A66C0}article{margin:0}article header{margin-bottom:20px;padding-bottom:20px}article header h1{margin-bottom:2px;font-weight:700;color:#000}article header time{color:#9E9E9E;font-size:0.85em;float:right}article header time.left{color:#9E9E9E;font-size:0.85em;float:left}article p{font-size:16px;margin-bottom:20px;line-height:1.6em}article p.note{background:#f5f5f5;border:1px solid #ddd;padding:0.533em 0.733em}article p.update{background-color:#FEEFB3;border:1px solid #e6e68a;padding:0.533em 0.733em}article p.alert{background-color:#ffe2e2;border:1px solid #ffb2b2;padding:0.533em 0.733em}article ul,article ol{margin-top:0px;margin-bottom:25px}article li{font-size:16px;line-height:1.6em}article a:hover{text-decoration:underline}article blockquote{border-left:2px solid #c7c7cc;color:#666;margin:30px 0;padding:0 0 0 25px}article img{max-width:100%}article code{color:#333;background-color:#EEE;border-radius:0;font-size:13px}article .codehilite pre{border-radius:0;background-color:#202020;color:#d0d0d0}article .codehilite pre code{border:none}article .codehilite pre.bash{background-color:#000;color:#FFF}article .meta{font-size:11px}article .meta a:hover{text-decoration:none}article .meta div{margin-bottom:20px;display:block}article .meta a.tag{margin:0 10px 10px 0;padding:1px 12px;display:inline-block;font-size:12px;color:rgba(0,0,0,0.6);background:rgba(0,0,0,0.05)}article .meta a.tag:hover{background:rgba(0,0,0,0.15)}article .meta a.read_more,article .meta a.comments_btn{font-size:14px;font-weight:800;padding:10px 20px;color:#007EE5;background:#FFF;border:1px solid #007EE5}article .meta a.read_more:hover,article .meta a.comments_btn:hover{color:#FFF;background:#007EE5}.index{max-width:700px}.index article header h2{font-size:36px;margin-bottom:2px;font-weight:700}.index article header h2 a{color:#000}.index article header h2 a:hover{color:#007ee5;text-decoration:none}.index .separator{padding:40px 0 0 0;margin:0 0 40px 0;height:10px;border-bottom:solid 1px #CCC}.index .pagination{display:block;margin-bottom:100px}.index .pagination .left{text-align:right}.index .pagination .right{text-align:left}.index .pagination a{display:inline-block;border:2px solid #007EE5;margin:0 5px;padding:8px 20px;font-weight:bold;color:#007EE5}.index .pagination a:hover{color:#FFF;background:#007EE5}.post{max-width:700px}.post h2:before{content:"# ";font-weight:bold;color:#DDD}.post h3:before{content:"## ";font-weight:bold;color:#DDD}.post h4:before{content:"### ";font-weight:bold;color:#DDD}.post article .meta{margin:50px 0 100px}.list{max-width:700px}.list ul.double-list{margin:0 auto 60px;padding:0;list-style-type:none}.list ul.double-list li{padding:5px 0}.list ul.double-list li h2{font-size:1em;display:inline;font-weight:normal}.list ul.double-list li span{font-family:sans-serif;text-transform:uppercase;text-align:right;float:right;padding-top:3px;font-size:12px;color:#999}.full-width-content{padding-top:10px;padding-left:0px;padding-right:0px;margin-left:-20px;margin-right:-20px}.col-xs-1,.col-sm-1,.col-md-1,.col-lg-1,.col-xs-2,.col-sm-2,.col-md-2,.col-lg-2,.col-xs-3,.col-sm-3,.col-md-3,.col-lg-3,.col-xs-4,.col-sm-4,.col-md-4,.col-lg-4,.col-xs-5,.col-sm-5,.col-md-5,.col-lg-5,.col-xs-6,.col-sm-6,.col-md-6,.col-lg-6,.col-xs-7,.col-sm-7,.col-md-7,.col-lg-7,.col-xs-8,.col-sm-8,.col-md-8,.col-lg-8,.col-xs-9,.col-sm-9,.col-md-9,.col-lg-9,.col-xs-10,.col-sm-10,.col-md-10,.col-lg-10,.col-xs-11,.col-sm-11,.col-md-11,.col-lg-11,.col-xs-12,.col-sm-12,.col-md-12,.col-lg-12{padding-right:0px;padding-left:0px}</style>

    </head>

    <body>
        <header class="navbar navbar-static-top bs-docs-nav main-header">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/" title="Home" class="title">Daniel Rodriguez</a></li>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/about.html" title="About">About</a></li>
                            <li><a href="http://github.com/vipings" title="vipings's Github" rel="me">Github</a></li>
                            <li><a href="http://twitter.com/vipingsnair" title="vipingsnair Twitter" rel="me">Twitter</a></li>
                            <li><a href="/archives.html" title="Archive">Archive</a></li>
                            <li><a href="/feeds/all.atom.xml" title="danielfrg.github.io RSS feed" rel="me">RSS</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div id="wrap">
<div class="container post">
    <article>
        <header>
            <h1>Jupyter Hub on Kubernetes Part II: NFS</h1>
            <time datetime="article.date.isoformat()" pubdate>September 10, 2016</time>
        </header>

        <div class="article_content">
            <p>Second part of my JupyterHub deployment in Kubernetes experiment be sure to read <a href="https://blog.vipings.com/blog/2016/09/03/jupyterhub-kubernetes-ldap/">Part I</a>.</p>
<p>Last time we got JupyterHub authenticating to LDAP and creating the single user notebooks in
Kubernetes containers. As I mentioned in that post one big problem with that deployment
was that the notebook files are gone when the pod is deleted
so this time I add an NFS volume to the JupyterHub single user containers to
persist the notebook data.</p>
<p>Also improved a little bit the deployment and code so to its no longer needed to build a custom image you
can just pull two images from my docker hub registry and configure them using
a <a href="http://kubernetes.io/docs/user-guide/configmap">Kubernetes ConfigMap</a>.</p>
<p>All the code in this post is at
<a href="https://github.com/danielfrg/jupyterhub-kubernetes_spawner">danielfrg/jupyterhub-kubernetes_spawner</a>.
Specifically in the <code>example</code> directory.</p>
<h2>NFS</h2>
<p>There is multiple options to have <a href="http://kubernetes.io/docs/user-guide/persistent-volumes/">persistent data in Kubernetes containers</a>.
I chose NFS because its one of the few types that allows multiple containers to have read and write access
(ReadWriteMany).
Most of the persistent volume types have read and write access to only one container (ReadWriteOnce)
and/or read only access to multiple containers (ReadOnlyMany).</p>
<p>I wanted to have all JupyterHub single user containers write their notebooks to the same location so its
easier to do backups of the data but since the notebook servers are single user each one of those
containers could use its own disk. On that case backup and maintenance is more complicated.</p>
<p>The following is heavily based on the <a href="https://github.com/kubernetes/kubernetes/tree/master/examples/volumes/nfs">Kubernetes NFS documentation</a>.</p>
<p>In order to mount an NFS volume into the Kubernetes containers we need an NFS server but even before that we
need a Volume that the NFS server can use to store the data.</p>
<p>In GCE we can use a persistent volume claim to ask for a Disk resource:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-storage</span>
  <span class="l l-Scalar l-Scalar-Plain">annotations</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">volume.alpha.kubernetes.io/storage-class</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">any</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">accessModes</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;ReadWriteOnce&quot;</span><span class="p p-Indicator">]</span>
  <span class="l l-Scalar l-Scalar-Plain">resources</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">requests</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">storage</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">200Gi</span>
</pre></div>


<p>When you execute this using <code>kubectl -f file.yaml</code> GCE will create a new disk that you can see at the GCE
cloud console, something like this:</p>
<p>{% b64img articles/2016/08/jupyterhub-nfs/gce-disk.png "GCE created disk" %}</p>
<p>Now that we have a Disk that the NFS server can use to store its data we create a Deployment of the NFS server
and a service to expose it.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs-server</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gcr.io/google-samples/nfs-server:1.1</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2049</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mountd</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20048</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rpcbind</span>
            <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">111</span>
        <span class="l l-Scalar l-Scalar-Plain">securityContext</span><span class="p p-Indicator">:</span>
          <span class="l l-Scalar l-Scalar-Plain">privileged</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
        <span class="l l-Scalar l-Scalar-Plain">volumeMounts</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mypvc</span>
            <span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/exports</span>
      <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mypvc</span>
          <span class="l l-Scalar l-Scalar-Plain">persistentVolumeClaim</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">claimName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-storage</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs</span>
      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2049</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">mountd</span>
      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">20048</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">rpcbind</span>
      <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">111</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs</span>
</pre></div>


<p>All this can be found in the <code>example/nfs.yml</code> file when executed there should be a <code>jupyterhub-nfs</code> service.</p>
<div class="codehilite">
<pre class="bash">
$ kubectl create -f example/nfs.yml
...

$ kubectl get services
NAME                     CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
jupyterhub-nfs           10.103.253.185   <none>            2049/TCP,20048/TCP,111/TCP   15h
</div>

</pre>

<p>Now with the NFS service ready we need to create a Persistent Volume and another Persistent Volume Claim
for the containers to use.
There is a need for a small manual step here since at the moment its not possible to get a service IP
from a Persistent Volume Object. So open <code>example/nfs2.yml</code> and change <code>{{ X.X.X.X }}</code> for the <code>jupyterhub-nfs</code>
service IP, in this case <code>10.103.253.185</code>.</p>
<p>The <code>nfs2.yml</code> file also includes a small NGINX deployment with <code>autoindex on;</code> to see the files on the
server. Its the base <code>nginx</code> image with a ConfigMap to change the default NGNIX conf file.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs-web-config</span>
<span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">default.conf</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|-</span>
    <span class="no">server {</span>
        <span class="no">listen   80;</span>
            <span class="no">server_name  localhost;</span>
            <span class="no">root /usr/share/nginx/html;</span>
            <span class="no">location / {</span>
                <span class="no">index none;</span>
                <span class="no">autoindex on;</span>
                <span class="no">autoindex_exact_size off;</span>
                <span class="no">autoindex_localtime on;</span>
        <span class="no">}</span>
    <span class="no">}</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">extensions/v1beta1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs-web</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">replicas</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="l l-Scalar l-Scalar-Plain">template</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
        <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs-web</span>
    <span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
      <span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">web</span>
        <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="l l-Scalar l-Scalar-Plain">volumeMounts</span><span class="p p-Indicator">:</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs</span>
            <span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span> <span class="s">&quot;/usr/share/nginx/html&quot;</span>
          <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
            <span class="l l-Scalar l-Scalar-Plain">mountPath</span><span class="p p-Indicator">:</span> <span class="s">&quot;/etc/nginx/conf.d/&quot;</span>
      <span class="l l-Scalar l-Scalar-Plain">volumes</span><span class="p p-Indicator">:</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">nfs</span>
          <span class="l l-Scalar l-Scalar-Plain">persistentVolumeClaim</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">claimName</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs</span>
        <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">config-volume</span>
          <span class="l l-Scalar l-Scalar-Plain">configMap</span><span class="p p-Indicator">:</span>
            <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-nfs-web-config</span>
</pre></div>


<p>Start the deployment and service and you should see a new <code>jupyterhub-nfs-web</code> service</p>
<div class="codehilite">
<pre class="bash">
$ kubectl create -f example/nfs2.yml
...

$ kubectl get services
NAME                     CLUSTER-IP       EXTERNAL-IP       PORT(S)                      AGE
jupyterhub-nfs-web       10.103.241.248   104.197.178.53    80/TCP                       15h
</div>

</pre>

<p>Going to that External IP you should see an empty NGINX file listing.</p>
<p>Thats it! You have a NFS server and the <code>kubernetes_spawer</code> will take care of mounting it to the
containers based on some settings.</p>
<h2>JupyterHub</h2>
<p>Last time we had the JupyterHub creating containers in Kubernetes now we have the same functionality
but it should be easier to get it running and configured based on a Kubernetes ConfigMap and
two example docker images I uploaded to <a href="https://hub.docker.com/u/danielfrg">my docker registry</a>.</p>
<p>In the last post it was needed to create custom a JupyterHub container images
for each deployment, this image used to havethe <code>jupyterhub_config.py</code> file with some values
(credentials and ip addresses).
I changed that deployment to user a Kubernetes ConfigMap that creates the config file so
some base container images can be reused and just need to fill the missing values in the
ConfigMap (<code>example/hub.yml</code>).</p>
<ol>
<li><a href="https://hub.docker.com/r/danielfrg/jupyterhub-kube-ldap">danielfrg/jupyterhub-kube-ldap</a>:
Is based on <a href="https://hub.docker.com/r/jupyterhub/jupyterhub">jupyterhub/jupyterhub</a> and includes the
<a href="https://github.com/jupyterhub/ldapauthenticator">jupyterhub/ldapauthenticator</a> and my <a href="https://github.com/danielfrg/jupyterhub-kubernetes_spawner">jupyterhub-kubernetes_spawner</a></li>
<li><a href="https://hub.docker.com/r/danielfrg/jupyterhub-kube-ldap-singleuser/">danielfrg/jupyterhub-kube-ldap-singleuser</a>:
Is based on <a href="https://hub.docker.com/r/jupyterhub/singleuser/">jupyterhub/singleuser</a> and just has different startup script to create the working notebook directory before starting the <code>jupyterhub-singleuser</code> server</li>
</ol>
<p>There is some missing values that need to be filled before starting the deployment
but they are very easy to find.</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-config-py</span>
<span class="l l-Scalar l-Scalar-Plain">data</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">jupyterhub-config.py</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">|-</span>
    <span class="no">c.JupyterHub.confirm_no_ssl = True</span>
    <span class="no">c.JupyterHub.db_url = &#39;sqlite:////tmp/jupyterhub.sqlite&#39;</span>
    <span class="no">c.JupyterHub.cookie_secret_file = &#39;/tmp/jupyterhub_cookie_secret&#39;</span>

    <span class="no">c.JupyterHub.authenticator_class = &#39;ldapauthenticator.LDAPAuthenticator&#39;</span>
    <span class="no">c.LDAPAuthenticator.bind_dn_template = &#39;cn={username},cn=jupyterhub,dc=example,dc=org&#39;</span>
    <span class="no"># c.LDAPAuthenticator.server_address = &#39;{{ LDAP_SERVICE_IP }}&#39;</span>
    <span class="no">c.LDAPAuthenticator.use_ssl = False</span>

    <span class="no">c.JupyterHub.spawner_class = &#39;kubernetes_spawner.KubernetesSpawner&#39;</span>
    <span class="no"># c.KubernetesSpawner.host = &#39;{{ KUBE_HOST }}&#39;</span>
    <span class="no"># c.KubernetesSpawner.username = &#39;{{ KUBE_USER }}&#39;</span>
    <span class="no"># c.KubernetesSpawner.password = &#39;{{ KUBE_PASS }}&#39;</span>
    <span class="no">c.KubernetesSpawner.verify_ssl = False</span>
    <span class="no">c.KubernetesSpawner.hub_ip_from_service = &#39;jupyterhub&#39;</span>
    <span class="no">c.KubernetesSpawner.container_image = &quot;danielfrg/jupyterhub-kube-ldap-singleuser:0.1&quot;</span>
    <span class="no">c.Spawner.notebook_dir = &#39;/mnt/notebooks/%U&#39;</span>
    <span class="no">c.KubernetesSpawner.persistent_volume_claim_name = &#39;jupyterhub-nfs&#39;</span>
    <span class="no">c.KubernetesSpawner.persistent_volume_claim_path = &#39;/mnt&#39;</span>
</pre></div>


<p>Based on the default settings the Kubernetes spawner will user a Kubernetes Persistent Volume Claim and mount
it under <code>/mnt</code> then I just have to tell the Spawner what directory under <code>/mnt</code> to use for the user notebooks,
for example '/mnt/notebooks/danielfrg'.</p>
<p>Start the JupyterHub service same as before.</p>
<div class="codehilite">
<pre class="bash">
$ kubectl create -f hub.yml
</div>

</pre>

<p>Wait for the service to give you an External IP and login as any LDAP user (see <a href="https://blog.vipings.com/blog/2016/09/03/jupyterhub-kubernetes-ldap/">Part I</a>).</p>
<p>After logging in a new pod will be created and mount the Persistent Volume Claim that uses the NFS Server.
Create a couple of notebooks and in the <code>jupyterhub-nfs-web</code> service you should see something like this.</p>
<p>{% b64img articles/2016/08/jupyterhub-nfs/nfs-web.png "NFS web files" %}</p>
<p>Now from the JupyterHub admin interface you should be able to terminate the server and start a new one<br />
and the notebooks should be persisted even when they will be a different Pod.</p>
<h2>Future</h2>
<p>I think that the persisting notebooks was the biggest issue with the previous deployment
that was fixed but there is some security issues.</p>
<p>All the JupyterHub single user containers run using the same user (<code>root</code> in this example) and the
whole NFS is mounted to all the containers this means that all the users have access
to all the (other users) notebooks. Even if by default it only shows the user notebooks its
possible to access the files at <code>/mnt</code>.</p>
<p>There are some <a href="http://www.tldp.org/HOWTO/NFS-HOWTO/security.html">possible solutions</a>
in the NFS side but it can also happen in the Kubernetes and Docker side, maybe
with a custom Persistent Volume Claim per user (?). More work is needed here.</p>
<p>The second big (also security) issue right now is how the JupyterHub access the Kubernetes API.
Right now its needed to put the credentials in the ConfigMap and I was planning on
user Kubernetes secrets to make it a little bit more secure but thats not needed.</p>
<p>While I was building this post I found (as I should have expected) that Kubernetes thought about this
issue and that it has the concept of
<a href="http://kubernetes.io/docs/user-guide/service-accounts/">Service Accounts</a>.</p>
<p>With a Service Account its possible to access the Kubernetes API without having to use the User Account
credentials. These Service Account credentials can even be mounted (and are by default) to a container
so it should be very easy to change the code to use them.</p>
<p>This removes the need to have a secondary User Account for the JupyterHub. Thanks Kubernetes!</p>
<p>This is probably the last (big) post about the this experiment but I plan to keep working on
the <a href="https://github.com/danielfrg/jupyterhub-kubernetes_spawner">kubernetes_spawner</a> to make it better.
At minimum I am for sure going to test and user the Service Account to make the deployment more secure.</p>
<p class="update">
<strong>Update:</strong> I have added support for Kubernetes Service Accounts to the kubernetes_spawner.
So user account credentials are no longer needed.

For updated docs and information take a look at the example folder here:
<a href="https://github.com/danielfrg/jupyterhub-kubernetes_spawner/tree/master/examples/ldap_nfs">examples/ldap_nfs</a>.
</p>
        </div>

        <div class="meta">
            <div>
                    <a href="https://blog.vipings.com/tag/jupyter-hub.html" class="tag">Jupyter Hub</a>
                    <a href="https://blog.vipings.com/tag/kubernetes.html" class="tag">Kubernetes</a>
                    <a href="https://blog.vipings.com/tag/ldap.html" class="tag">LDAP</a>
                    <a href="https://blog.vipings.com/tag/docker.html" class="tag">Docker</a>
                    <a href="https://blog.vipings.com/tag/nfs.html" class="tag">NFS</a>
            </div>
        </div>
    </article>
</div>

<style type="text/css">
{
    max-width: 700px;
}

.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
    max-width: 580px;
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}

table.dataframe th, td {
    padding: 4px;
    text-align: left;
}

pre code {
    background-color: inherit;
}</style>

        </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35523657-2', 'danielfrg.com');
  ga('send', 'pageview');

</script>

    </body>
</html>