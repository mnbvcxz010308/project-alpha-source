<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Vipin G S">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Jupyter Hub on Kubernetes with LDAP | EssentialDataScience</title>

        <link rel="alternate" type="application/atom+xml" title="EssentialDataScience blog atom feed" href="/feeds/all.atom.xml" />
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <style>.codehilite .hll { background-color: #404040 }
.codehilite .c { color: #999999; font-style: italic } /* Comment */
.codehilite .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.codehilite .g { color: #d0d0d0 } /* Generic */
.codehilite .k { color: #6ab825; font-weight: bold } /* Keyword */
.codehilite .l { color: #d0d0d0 } /* Literal */
.codehilite .n { color: #d0d0d0 } /* Name */
.codehilite .o { color: #d0d0d0 } /* Operator */
.codehilite .x { color: #d0d0d0 } /* Other */
.codehilite .p { color: #d0d0d0 } /* Punctuation */
.codehilite .cm { color: #999999; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #cd2828; font-weight: bold } /* Comment.Preproc */
.codehilite .c1 { color: #999999; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #e50808; font-weight: bold; background-color: #520000 } /* Comment.Special */
.codehilite .gd { color: #d22323 } /* Generic.Deleted */
.codehilite .ge { color: #d0d0d0; font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #d22323 } /* Generic.Error */
.codehilite .gh { color: #ffffff; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #589819 } /* Generic.Inserted */
.codehilite .go { color: #cccccc } /* Generic.Output */
.codehilite .gp { color: #aaaaaa } /* Generic.Prompt */
.codehilite .gs { color: #d0d0d0; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #ffffff; text-decoration: underline } /* Generic.Subheading */
.codehilite .gt { color: #d22323 } /* Generic.Traceback */
.codehilite .kc { color: #6ab825; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #6ab825; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #6ab825; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #6ab825 } /* Keyword.Pseudo */
.codehilite .kr { color: #6ab825; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #6ab825; font-weight: bold } /* Keyword.Type */
.codehilite .ld { color: #d0d0d0 } /* Literal.Date */
.codehilite .m { color: #3677a9 } /* Literal.Number */
.codehilite .s { color: #ed9d13 } /* Literal.String */
.codehilite .na { color: #bbbbbb } /* Name.Attribute */
.codehilite .nb { color: #24909d } /* Name.Builtin */
.codehilite .nc { color: #447fcf; text-decoration: underline } /* Name.Class */
.codehilite .no { color: #40ffff } /* Name.Constant */
.codehilite .nd { color: #ffa500 } /* Name.Decorator */
.codehilite .ni { color: #d0d0d0 } /* Name.Entity */
.codehilite .ne { color: #bbbbbb } /* Name.Exception */
.codehilite .nf { color: #447fcf } /* Name.Function */
.codehilite .nl { color: #d0d0d0 } /* Name.Label */
.codehilite .nn { color: #447fcf; text-decoration: underline } /* Name.Namespace */
.codehilite .nx { color: #d0d0d0 } /* Name.Other */
.codehilite .py { color: #d0d0d0 } /* Name.Property */
.codehilite .nt { color: #6ab825; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #40ffff } /* Name.Variable */
.codehilite .ow { color: #6ab825; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #666666 } /* Text.Whitespace */
.codehilite .mf { color: #3677a9 } /* Literal.Number.Float */
.codehilite .mh { color: #3677a9 } /* Literal.Number.Hex */
.codehilite .mi { color: #3677a9 } /* Literal.Number.Integer */
.codehilite .mo { color: #3677a9 } /* Literal.Number.Oct */
.codehilite .sb { color: #ed9d13 } /* Literal.String.Backtick */
.codehilite .sc { color: #ed9d13 } /* Literal.String.Char */
.codehilite .sd { color: #ed9d13 } /* Literal.String.Doc */
.codehilite .s2 { color: #ed9d13 } /* Literal.String.Double */
.codehilite .se { color: #ed9d13 } /* Literal.String.Escape */
.codehilite .sh { color: #ed9d13 } /* Literal.String.Heredoc */
.codehilite .si { color: #ed9d13 } /* Literal.String.Interpol */
.codehilite .sx { color: #ffa500 } /* Literal.String.Other */
.codehilite .sr { color: #ed9d13 } /* Literal.String.Regex */
.codehilite .s1 { color: #ed9d13 } /* Literal.String.Single */
.codehilite .ss { color: #ed9d13 } /* Literal.String.Symbol */
.codehilite .bp { color: #24909d } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #40ffff } /* Name.Variable.Class */
.codehilite .vg { color: #40ffff } /* Name.Variable.Global */
.codehilite .vi { color: #40ffff } /* Name.Variable.Instance */
.codehilite .il { color: #3677a9 } /* Literal.Number.Integer.Long */</style>
        <style>body{margin:0;padding:0;font:15px 'Source Sans Pro',sans-serif;line-height:1.6em;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}a{color:#007ee5;text-decoration:none}a:hover{color:#007ee5;text-decoration:none}header.main-header{background:none repeat scroll 0% 0% #2A66C0;margin-bottom:0px}header.main-header a{color:#fff}header.main-header .container{max-width:1000px}header.main-header .container nav a:hover{background-color:#2A66C0}article{margin:0}article header{margin-bottom:20px;padding-bottom:20px}article header h1{margin-bottom:2px;font-weight:700;color:#000}article header time{color:#9E9E9E;font-size:0.85em;float:right}article header time.left{color:#9E9E9E;font-size:0.85em;float:left}article p{font-size:16px;margin-bottom:20px;line-height:1.6em}article p.note{background:#f5f5f5;border:1px solid #ddd;padding:0.533em 0.733em}article p.update{background-color:#FEEFB3;border:1px solid #e6e68a;padding:0.533em 0.733em}article p.alert{background-color:#ffe2e2;border:1px solid #ffb2b2;padding:0.533em 0.733em}article ul,article ol{margin-top:0px;margin-bottom:25px}article li{font-size:16px;line-height:1.6em}article a:hover{text-decoration:underline}article blockquote{border-left:2px solid #c7c7cc;color:#666;margin:30px 0;padding:0 0 0 25px}article img{max-width:100%}article code{color:#333;background-color:#EEE;border-radius:0;font-size:13px}article .codehilite pre{border-radius:0;background-color:#202020;color:#d0d0d0}article .codehilite pre code{border:none}article .codehilite pre.bash{background-color:#000;color:#FFF}article .meta{font-size:11px}article .meta a:hover{text-decoration:none}article .meta div{margin-bottom:20px;display:block}article .meta a.tag{margin:0 10px 10px 0;padding:1px 12px;display:inline-block;font-size:12px;color:rgba(0,0,0,0.6);background:rgba(0,0,0,0.05)}article .meta a.tag:hover{background:rgba(0,0,0,0.15)}article .meta a.read_more,article .meta a.comments_btn{font-size:14px;font-weight:800;padding:10px 20px;color:#007EE5;background:#FFF;border:1px solid #007EE5}article .meta a.read_more:hover,article .meta a.comments_btn:hover{color:#FFF;background:#007EE5}.index{max-width:700px}.index article header h2{font-size:36px;margin-bottom:2px;font-weight:700}.index article header h2 a{color:#000}.index article header h2 a:hover{color:#007ee5;text-decoration:none}.index .separator{padding:40px 0 0 0;margin:0 0 40px 0;height:10px;border-bottom:solid 1px #CCC}.index .pagination{display:block;margin-bottom:100px}.index .pagination .left{text-align:right}.index .pagination .right{text-align:left}.index .pagination a{display:inline-block;border:2px solid #007EE5;margin:0 5px;padding:8px 20px;font-weight:bold;color:#007EE5}.index .pagination a:hover{color:#FFF;background:#007EE5}.post{max-width:700px}.post h2:before{content:"# ";font-weight:bold;color:#DDD}.post h3:before{content:"## ";font-weight:bold;color:#DDD}.post h4:before{content:"### ";font-weight:bold;color:#DDD}.post article .meta{margin:50px 0 100px}.list{max-width:700px}.list ul.double-list{margin:0 auto 60px;padding:0;list-style-type:none}.list ul.double-list li{padding:5px 0}.list ul.double-list li h2{font-size:1em;display:inline;font-weight:normal}.list ul.double-list li span{font-family:sans-serif;text-transform:uppercase;text-align:right;float:right;padding-top:3px;font-size:12px;color:#999}.full-width-content{padding-top:10px;padding-left:0px;padding-right:0px;margin-left:-20px;margin-right:-20px}.col-xs-1,.col-sm-1,.col-md-1,.col-lg-1,.col-xs-2,.col-sm-2,.col-md-2,.col-lg-2,.col-xs-3,.col-sm-3,.col-md-3,.col-lg-3,.col-xs-4,.col-sm-4,.col-md-4,.col-lg-4,.col-xs-5,.col-sm-5,.col-md-5,.col-lg-5,.col-xs-6,.col-sm-6,.col-md-6,.col-lg-6,.col-xs-7,.col-sm-7,.col-md-7,.col-lg-7,.col-xs-8,.col-sm-8,.col-md-8,.col-lg-8,.col-xs-9,.col-sm-9,.col-md-9,.col-lg-9,.col-xs-10,.col-sm-10,.col-md-10,.col-lg-10,.col-xs-11,.col-sm-11,.col-md-11,.col-lg-11,.col-xs-12,.col-sm-12,.col-md-12,.col-lg-12{padding-right:0px;padding-left:0px}</style>

    </head>

    <body>
        <header class="navbar navbar-static-top bs-docs-nav main-header">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/" title="Home" class="title">Daniel Rodriguez</a></li>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/about.html" title="About">About</a></li>
                            <li><a href="http://github.com/vipings" title="vipings's Github" rel="me">Github</a></li>
                            <li><a href="http://twitter.com/vipingsnair" title="vipingsnair Twitter" rel="me">Twitter</a></li>
                            <li><a href="/archives.html" title="Archive">Archive</a></li>
                            <li><a href="/feeds/all.atom.xml" title="danielfrg.github.io RSS feed" rel="me">RSS</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div id="wrap">
<div class="container post">
    <article>
        <header>
            <h1>Jupyter Hub on Kubernetes with LDAP</h1>
            <time datetime="article.date.isoformat()" pubdate>September 03, 2016</time>
        </header>

        <div class="article_content">
            <p>In this post I am going to show some initial work I did in the last day to deploy
Jupyter Hub in Kubernetes with user auth based on LDAP.</p>
<p>I wasn't that much work considering that Jupyter Hub already had support for LDAP user auth and
the modularity they have is amazing. It was quite straight forward to write a new spawner
based on the existing one on the <a href="https://github.com/jupyterhub/jupyterhub">Jupyter Hub github org</a>.</p>
<p>All the code in this post is at
<a href="https://github.com/danielfrg/jupyterhub-kubernetes_spawner">danielfrg/jupyterhub-kubernetes_spawner</a>.
Specifically in the <code>examples</code> directory.</p>
<p>I consider this a nice example of a more production ready Jupyter Hub deployment being based on LDAP
that for good or bad is everywhere and Kubernetes to deployment of the single user notebook servers.</p>
<p>Something I don't talk is SSL certificates because its very well supported on Jupyter Hub and
I think there is enough information about them on the Jupyter Hub docs and online.
And yes, I was lazy to do it :)</p>
<h2>Requirements</h2>
<p>Basically the only requirement to get this running is a Kubernetes cluster (credentials) and time.</p>
<p>By far the best way to get a Kubernetes cluster is to use the
<a href="https://cloud.google.com/container-engine/">Google Container Engine</a> to create one.</p>
<p>From this point I am assuming you have one.</p>
<h2>LDAP</h2>
<p>LDAP will be the user directory that we are going to use authenticate in Jupyter Hub.
Just as an example we are going to deploy <code>openlpad</code> and <code>phpldapadmin</code> as an UI also in the
same Kubernetes cluster.</p>
<p>In the example directory I provide an <code>ldap.yml</code> file that has a simple kubernetes deployment
object and one service to expose the <code>phpldapadmin</code> UI.</p>
<p>The deployment consist of only one Pod with two containers.</p>
<p>First container is <code>openldap</code>:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">openldap</span>
  <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">osixia/openldap</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">389</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">636</span>
</pre></div>


<p>Second container is <code>phpldapadmin</code>, disabling HTTPS (so port 80) and the LDAP host being <code>localhost</code> since
its the same Pod:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">phpldapadmin</span>
  <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">osixia/phpldapadmin</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
  <span class="l l-Scalar l-Scalar-Plain">env</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PHPLDAPADMIN_HTTPS</span>
    <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="s">&quot;false&quot;</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">PHPLDAPADMIN_LDAP_HOSTS</span>
    <span class="l l-Scalar l-Scalar-Plain">value</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
</pre></div>


<p>Finaly one simple Kubernetes service to expose the <code>phpldapadmin</code> UI:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-ldap</span>
</pre></div>


<p>To deploy everything just need to run:</p>
<div class="codehilite">
<pre class="bash">
$ kubectl create -f ldap.yml
deployment "jupyterhub-ldap" created
service "jupyterhub-ldap-admin" created
</div>

</pre>

<p>After that just wait for the Pod to be ready and the service to give you a public IP:</p>
<div class="codehilite">
<pre class="bash">
$ kubectl get deployments
NAME               DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
jupyterhub-ldap    1         1         1            1           25s

$ kubectl get service
NAME                     CLUSTER-IP       EXTERNAL-IP       PORT(S)     AGE
jupyterhub-ldap-admin    10.103.241.31    104.154.70.197    80/TCP      56s
</div>

</pre>

<p>Now you can go to the External IP (<code>104.154.70.197</code> in my case) and see the <code>phpldapadmin</code> UI.</p>
<p>The default user is <code>admin</code> with <code>dc=example</code> and <code>dc=org</code> (in LDAP lang that means
DN=<code>cn=admin,dc=example,dc=org</code> in the user field) with password of <code>admin</code>.</p>
<p>Just as an example and to see how the auth works later lest create a couple of users.</p>
<p>First we need a <code>Posix Group</code> to place the users I chose: <code>jupyterhub</code>.
Under that group create a couple of <code>Generic: User Account</code> the result should look something like this:</p>
<p>{% b64img articles/2016/08/jupyterhub-ldap/phpldapadmin.png "PHP LDAL my admin" %}</p>
<p>Thats all the work we need to do in the LDAP front.</p>
<h2>Jupyter Hub</h2>
<p>Jupyter Hub basically consists of two parts the
<a href="https://github.com/jupyterhub/configurable-http-proxy">configurable-http-proxy</a>
which is a small magic utility and the actual <a href="https://github.com/jupyterhub/jupyterhub">Jupyter Hub</a>.</p>
<p>When you start the Jupyter Hub it will start the <code>configurable-http-proxy</code> but
I prefer to have each component in its own container like I show in the last deployment.</p>
<p>Before actually deploying the Jupyter Hub
we need to create a Docker image that has the Jupyter Hub plugins for ldap and my Kubernetes spawner.
We do this by extending the official <code>jupyterhub/jupyterhub</code> image:</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> jupyterhub/jupyterhub</span>

<span class="k">RUN</span> apt-get update <span class="o">&amp;&amp;</span> apt-get install -y curl
<span class="k">RUN</span> pip install jupyterhub-ldapauthenticator
<span class="k">RUN</span> pip install git+git://github.com/danielfrg/jupyterhub-kubernetes_spawner.git

COPY jupyterhub_config.py /srv/jupyterhub/jupyterhub_config.py
COPY start.sh /srv/jupyterhub/start.sh
<span class="k">RUN</span> chmod +x /srv/jupyterhub/start.sh

<span class="k">CMD</span><span class="s"> [&quot;/srv/jupyterhub/start.sh&quot;]</span>
</pre></div>


<p>The only think that is missing is fill the <code>jupyterhub_config.py</code> file with the missing values:
Kubernetes auth and LDAP server location.</p>
<div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">authenticator_class</span> <span class="o">=</span> <span class="s1">&#39;ldapauthenticator.LDAPAuthenticator&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LDAPAuthenticator</span><span class="o">.</span><span class="n">bind_dn_template</span> <span class="o">=</span> <span class="s1">&#39;cn={username},cn=jupyterhub,dc=example,dc=org&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LDAPAuthenticator</span><span class="o">.</span><span class="n">server_address</span> <span class="o">=</span> <span class="s1">&#39;{ LDAP_POD_ID }&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">LDAPAuthenticator</span><span class="o">.</span><span class="n">use_ssl</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">c</span><span class="o">.</span><span class="n">JupyterHub</span><span class="o">.</span><span class="n">spawner_class</span> <span class="o">=</span> <span class="s1">&#39;kubernetes_spawner.KubernetesSpawner&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">KubernetesSpawner</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="s1">&#39;{ KUBE_HOST }&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">KubernetesSpawner</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;{ KUBE_USER }&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">KubernetesSpawner</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;{ KUBE_PASS }&#39;</span>
<span class="n">c</span><span class="o">.</span><span class="n">KubernetesSpawner</span><span class="o">.</span><span class="n">verify_ssl</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">c</span><span class="o">.</span><span class="n">KubernetesSpawner</span><span class="o">.</span><span class="n">hub_ip_from_service</span> <span class="o">=</span> <span class="s2">&quot;jupyterhub&quot;</span>
</pre></div>


<p>The missing values are:</p>
<ul>
<li><code>LDAP_POD_ID</code>: Get this one from the Pod we created in the LDAP section:</li>
</ul>
<div class="codehilite">
<pre class="bash">
$ kubectl get Pods
NAME                               READY     STATUS    RESTARTS   AGE
jupyterhub-ldap-2860785391-pjiq7   2/2       Running   0          31m

$ kubectl describe Pod jupyterhub-ldap-2860785391-pjiq7 | grep ip
IP:         10.100.5.3
</div>

</pre>

<p>My value is <code>10.100.5.3</code>.</p>
<ul>
<li>Note <code>cn={username},cn=jupyterhub,dc=example,dc=org</code> has to match the structure created for the LDAP user entries.</li>
<li><code>KUBE_HOST</code>, <code>KUBE_USER</code>, <code>KUBEPASS</code>. Get those from <code>kubectl config view</code></li>
</ul>
<p>Now we need to create the image:</p>
<div class="codehilite">
<pre class="bash">
$ docker build -t gcr.io/continuum-compute/jupyterhub-kube:0.2 .
...

$ gcloud docker push gcr.io/continuum-compute/jupyterhub-kube:0.2
...
</div>

</pre>

<p>Notice the tag of the container is <code>gcr.io/continuum-compute/jupyterhub-kube:0.2</code> because
I upload the image to the Google Container Registry but it could be a container on Docker Hub.</p>
<p>Thats it! Now we can deploy this image using the <code>hub.yml</code> deployment file.</p>
<p>This deployment consists of one Pod with two containers.</p>
<p>First one is the <code>configurable-http-proxy</code>:</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">containers</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">proxy</span>
  <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub/configurable-http-proxy</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8001</span>
  <span class="l l-Scalar l-Scalar-Plain">command</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">configurable-http-proxy</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--ip</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--api-ip</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">0.0.0.0</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--default-target</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:8081</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">--error-target</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">http://127.0.0.1:8081/hub/error</span>
</pre></div>


<p>Second one is the actual Jupyter Hub server. Notice I use the image I created and uploaded before:</p>
<div class="highlight"><pre><span></span><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub</span>
  <span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">gcr.io/continuum-compute/jupyterhub-kube:0.2</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">containerPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8081</span>
</pre></div>


<p>Then two services to expose the APIs to the public</p>
<div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8000</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub</span>
<span class="nn">---</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="l l-Scalar l-Scalar-Plain">kind</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="l l-Scalar l-Scalar-Plain">metadata</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-api</span>
  <span class="l l-Scalar l-Scalar-Plain">labels</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub-api</span>
<span class="l l-Scalar l-Scalar-Plain">spec</span><span class="p p-Indicator">:</span>
  <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
  <span class="l l-Scalar l-Scalar-Plain">ports</span><span class="p p-Indicator">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">port</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="l l-Scalar l-Scalar-Plain">targetPort</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">8001</span>
  <span class="l l-Scalar l-Scalar-Plain">selector</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">app</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">jupyterhub</span>
</pre></div>


<p>Use the file to create the deployment and wait for the Public IPs to be assigned:</p>
<div class="codehilite">
<pre class="bash">
$ kubectl create -f hub.yml
deployment "jupyterhub" created
service "jupyterhub" created
service "jupyterhub-api" created

$ sleep 20

$ kubectl get service
NAME                     CLUSTER-IP       EXTERNAL-IP       PORT(S)     AGE
jupyterhub               10.103.254.164   130.211.158.251   80/TCP      2m
jupyterhub-api           10.103.248.253   130.211.117.81    80/TCP      2m
jupyterhub-ldap-admin    10.103.241.31    104.154.70.197    80/TCP      43m
</div>

</pre>

<p>In your browser go to the external IP of the jupyterhub service in my case: <code>130.211.158.251</code> and
you should see the Jupyter Hub UI. Now you should be able to log in using any of the user entries
in LDAP.</p>
<p>{% b64img articles/2016/08/jupyterhub-ldap/hub-login.png "JupyterHub login" %}</p>
<p>Note that it could take a minute to start the actual notebook server since the image
that is pulled for the notebook is quite big but once the image is downloaded
in the kubernetes cluster nodes it starts basically instantly.</p>
<p>As an experiment you can open an incognito window and login as another user.</p>
<p>Now you have two independent containers managed by Kubernetes and Jupyter Hub.</p>
<p>You can take a look at the running Pods now:</p>
<div class="codehilite">
<pre class="bash">
$ kubectl get Pods
jupyterhub-bzaitlen                1/1       Running   0          1m
jupyterhub-danielfrg               1/1       Running   0          7m
...
</div>

</pre>

<p>As expected stoping the server in the Jupyter Hub UI will stop the Pod.</p>
<h2>Future</h2>
<p>There is more work to be done the main issue is that even when Jupyter Hub is supposed to be a permanent
place for you notebooks the current setup will create a new container every time and the notebooks will be lost.
The solution to that is to share a persistent volume with the containers.</p>
<p>Also the notebook Pod are not started with any replication control. It would be nice to start them with one
so Kubernetes will restart them if they fail for any reason.</p>
<p>Finally there is some small things that can be done to make the config a little friendlier, for example
the LDAP host can be exposed as a service and user Kubernetes service discovery to find the correct location.
Probably trying to autodetect if the Jupyter Hub is being run in Kubernetes plus some sane defaults is the way to go.</p>
        </div>

        <div class="meta">
            <div>
                    <a href="https://blog.vipings.com/tag/jupyter-hub.html" class="tag">Jupyter Hub</a>
                    <a href="https://blog.vipings.com/tag/kubernetes.html" class="tag">Kubernetes</a>
                    <a href="https://blog.vipings.com/tag/ldap.html" class="tag">LDAP</a>
                    <a href="https://blog.vipings.com/tag/docker.html" class="tag">Docker</a>
            </div>
        </div>
    </article>
</div>

<style type="text/css">
{
    max-width: 700px;
}

.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
    max-width: 580px;
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}

table.dataframe th, td {
    padding: 4px;
    text-align: left;
}

pre code {
    background-color: inherit;
}</style>

        </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35523657-2', 'danielfrg.com');
  ga('send', 'pageview');

</script>

    </body>
</html>