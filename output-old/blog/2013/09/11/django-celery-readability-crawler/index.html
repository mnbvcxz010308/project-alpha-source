<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Vipin G S">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Django + Celery + Readability = Python relevant content crawler | EssentialDataScience</title>

        <link rel="alternate" type="application/atom+xml" title="EssentialDataScience blog atom feed" href="/feeds/all.atom.xml" />
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <style>.codehilite .hll { background-color: #404040 }
.codehilite .c { color: #999999; font-style: italic } /* Comment */
.codehilite .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.codehilite .g { color: #d0d0d0 } /* Generic */
.codehilite .k { color: #6ab825; font-weight: bold } /* Keyword */
.codehilite .l { color: #d0d0d0 } /* Literal */
.codehilite .n { color: #d0d0d0 } /* Name */
.codehilite .o { color: #d0d0d0 } /* Operator */
.codehilite .x { color: #d0d0d0 } /* Other */
.codehilite .p { color: #d0d0d0 } /* Punctuation */
.codehilite .cm { color: #999999; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #cd2828; font-weight: bold } /* Comment.Preproc */
.codehilite .c1 { color: #999999; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #e50808; font-weight: bold; background-color: #520000 } /* Comment.Special */
.codehilite .gd { color: #d22323 } /* Generic.Deleted */
.codehilite .ge { color: #d0d0d0; font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #d22323 } /* Generic.Error */
.codehilite .gh { color: #ffffff; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #589819 } /* Generic.Inserted */
.codehilite .go { color: #cccccc } /* Generic.Output */
.codehilite .gp { color: #aaaaaa } /* Generic.Prompt */
.codehilite .gs { color: #d0d0d0; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #ffffff; text-decoration: underline } /* Generic.Subheading */
.codehilite .gt { color: #d22323 } /* Generic.Traceback */
.codehilite .kc { color: #6ab825; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #6ab825; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #6ab825; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #6ab825 } /* Keyword.Pseudo */
.codehilite .kr { color: #6ab825; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #6ab825; font-weight: bold } /* Keyword.Type */
.codehilite .ld { color: #d0d0d0 } /* Literal.Date */
.codehilite .m { color: #3677a9 } /* Literal.Number */
.codehilite .s { color: #ed9d13 } /* Literal.String */
.codehilite .na { color: #bbbbbb } /* Name.Attribute */
.codehilite .nb { color: #24909d } /* Name.Builtin */
.codehilite .nc { color: #447fcf; text-decoration: underline } /* Name.Class */
.codehilite .no { color: #40ffff } /* Name.Constant */
.codehilite .nd { color: #ffa500 } /* Name.Decorator */
.codehilite .ni { color: #d0d0d0 } /* Name.Entity */
.codehilite .ne { color: #bbbbbb } /* Name.Exception */
.codehilite .nf { color: #447fcf } /* Name.Function */
.codehilite .nl { color: #d0d0d0 } /* Name.Label */
.codehilite .nn { color: #447fcf; text-decoration: underline } /* Name.Namespace */
.codehilite .nx { color: #d0d0d0 } /* Name.Other */
.codehilite .py { color: #d0d0d0 } /* Name.Property */
.codehilite .nt { color: #6ab825; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #40ffff } /* Name.Variable */
.codehilite .ow { color: #6ab825; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #666666 } /* Text.Whitespace */
.codehilite .mf { color: #3677a9 } /* Literal.Number.Float */
.codehilite .mh { color: #3677a9 } /* Literal.Number.Hex */
.codehilite .mi { color: #3677a9 } /* Literal.Number.Integer */
.codehilite .mo { color: #3677a9 } /* Literal.Number.Oct */
.codehilite .sb { color: #ed9d13 } /* Literal.String.Backtick */
.codehilite .sc { color: #ed9d13 } /* Literal.String.Char */
.codehilite .sd { color: #ed9d13 } /* Literal.String.Doc */
.codehilite .s2 { color: #ed9d13 } /* Literal.String.Double */
.codehilite .se { color: #ed9d13 } /* Literal.String.Escape */
.codehilite .sh { color: #ed9d13 } /* Literal.String.Heredoc */
.codehilite .si { color: #ed9d13 } /* Literal.String.Interpol */
.codehilite .sx { color: #ffa500 } /* Literal.String.Other */
.codehilite .sr { color: #ed9d13 } /* Literal.String.Regex */
.codehilite .s1 { color: #ed9d13 } /* Literal.String.Single */
.codehilite .ss { color: #ed9d13 } /* Literal.String.Symbol */
.codehilite .bp { color: #24909d } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #40ffff } /* Name.Variable.Class */
.codehilite .vg { color: #40ffff } /* Name.Variable.Global */
.codehilite .vi { color: #40ffff } /* Name.Variable.Instance */
.codehilite .il { color: #3677a9 } /* Literal.Number.Integer.Long */</style>
        <style>body{margin:0;padding:0;font:15px 'Source Sans Pro',sans-serif;line-height:1.6em;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}a{color:#007ee5;text-decoration:none}a:hover{color:#007ee5;text-decoration:none}header.main-header{background:none repeat scroll 0% 0% #2A66C0;margin-bottom:0px}header.main-header a{color:#fff}header.main-header .container{max-width:1000px}header.main-header .container nav a:hover{background-color:#2A66C0}article{margin:0}article header{margin-bottom:20px;padding-bottom:20px}article header h1{margin-bottom:2px;font-weight:700;color:#000}article header time{color:#9E9E9E;font-size:0.85em;float:right}article header time.left{color:#9E9E9E;font-size:0.85em;float:left}article p{font-size:16px;margin-bottom:20px;line-height:1.6em}article p.note{background:#f5f5f5;border:1px solid #ddd;padding:0.533em 0.733em}article p.update{background-color:#FEEFB3;border:1px solid #e6e68a;padding:0.533em 0.733em}article p.alert{background-color:#ffe2e2;border:1px solid #ffb2b2;padding:0.533em 0.733em}article ul,article ol{margin-top:0px;margin-bottom:25px}article li{font-size:16px;line-height:1.6em}article a:hover{text-decoration:underline}article blockquote{border-left:2px solid #c7c7cc;color:#666;margin:30px 0;padding:0 0 0 25px}article img{max-width:100%}article code{color:#333;background-color:#EEE;border-radius:0;font-size:13px}article .codehilite pre{border-radius:0;background-color:#202020;color:#d0d0d0}article .codehilite pre code{border:none}article .codehilite pre.bash{background-color:#000;color:#FFF}article .meta{font-size:11px}article .meta a:hover{text-decoration:none}article .meta div{margin-bottom:20px;display:block}article .meta a.tag{margin:0 10px 10px 0;padding:1px 12px;display:inline-block;font-size:12px;color:rgba(0,0,0,0.6);background:rgba(0,0,0,0.05)}article .meta a.tag:hover{background:rgba(0,0,0,0.15)}article .meta a.read_more,article .meta a.comments_btn{font-size:14px;font-weight:800;padding:10px 20px;color:#007EE5;background:#FFF;border:1px solid #007EE5}article .meta a.read_more:hover,article .meta a.comments_btn:hover{color:#FFF;background:#007EE5}.index{max-width:700px}.index article header h2{font-size:36px;margin-bottom:2px;font-weight:700}.index article header h2 a{color:#000}.index article header h2 a:hover{color:#007ee5;text-decoration:none}.index .separator{padding:40px 0 0 0;margin:0 0 40px 0;height:10px;border-bottom:solid 1px #CCC}.index .pagination{display:block;margin-bottom:100px}.index .pagination .left{text-align:right}.index .pagination .right{text-align:left}.index .pagination a{display:inline-block;border:2px solid #007EE5;margin:0 5px;padding:8px 20px;font-weight:bold;color:#007EE5}.index .pagination a:hover{color:#FFF;background:#007EE5}.post{max-width:700px}.post h2:before{content:"# ";font-weight:bold;color:#DDD}.post h3:before{content:"## ";font-weight:bold;color:#DDD}.post h4:before{content:"### ";font-weight:bold;color:#DDD}.post article .meta{margin:50px 0 100px}.list{max-width:700px}.list ul.double-list{margin:0 auto 60px;padding:0;list-style-type:none}.list ul.double-list li{padding:5px 0}.list ul.double-list li h2{font-size:1em;display:inline;font-weight:normal}.list ul.double-list li span{font-family:sans-serif;text-transform:uppercase;text-align:right;float:right;padding-top:3px;font-size:12px;color:#999}.full-width-content{padding-top:10px;padding-left:0px;padding-right:0px;margin-left:-20px;margin-right:-20px}.col-xs-1,.col-sm-1,.col-md-1,.col-lg-1,.col-xs-2,.col-sm-2,.col-md-2,.col-lg-2,.col-xs-3,.col-sm-3,.col-md-3,.col-lg-3,.col-xs-4,.col-sm-4,.col-md-4,.col-lg-4,.col-xs-5,.col-sm-5,.col-md-5,.col-lg-5,.col-xs-6,.col-sm-6,.col-md-6,.col-lg-6,.col-xs-7,.col-sm-7,.col-md-7,.col-lg-7,.col-xs-8,.col-sm-8,.col-md-8,.col-lg-8,.col-xs-9,.col-sm-9,.col-md-9,.col-lg-9,.col-xs-10,.col-sm-10,.col-md-10,.col-lg-10,.col-xs-11,.col-sm-11,.col-md-11,.col-lg-11,.col-xs-12,.col-sm-12,.col-md-12,.col-lg-12{padding-right:0px;padding-left:0px}</style>

    </head>

    <body>
        <header class="navbar navbar-static-top bs-docs-nav main-header">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/" title="Home" class="title">Daniel Rodriguez</a></li>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/about.html" title="About">About</a></li>
                            <li><a href="http://github.com/vipings" title="vipings's Github" rel="me">Github</a></li>
                            <li><a href="http://twitter.com/vipingsnair" title="vipingsnair Twitter" rel="me">Twitter</a></li>
                            <li><a href="/archives.html" title="Archive">Archive</a></li>
                            <li><a href="/feeds/all.atom.xml" title="danielfrg.github.io RSS feed" rel="me">RSS</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div id="wrap">
<div class="container post">
    <article>
        <header>
            <h1>Django + Celery + Readability = Python relevant content crawler</h1>
            <time datetime="article.date.isoformat()" pubdate>September 11, 2013</time>
        </header>

        <div class="article_content">
            <p>I have written a <a href="https://blog.vipings.com/blog/2013/08/20/relevant-content-blog-crawler/">few</a> <a href="https://blog.vipings.com/blog/2013/04/01/nba-scraping-data/">posts</a>
about crawling content from the web. Mainly because I know the power of data
and the biggest data source in the world is the web, Google knew it and we all now how they are
doing. In my <a href="https://blog.vipings.com/blog/2013/08/20/relevant-content-blog-crawler/">last post</a> I wrote about crawling relevant content
from blogs; It worked but what if I want an admin UI to control the crawling. What if I just put
the crawler in an EC2 instance and just call it when I need to crawl.</p>
<p>The solution was pretty simple thanks to some python projects.
I just needed to move from <a href="http://www.sqlalchemy.org/">sqlalchemy</a> to
<a href="https://docs.djangoproject.com/en/1.5/">django</a> ORM, create a few <a href="http://celeryproject.org/">celery</a> tasks
and use <a href="https://github.com/celery/django-celery/">django-celery</a> to have a pretty UI of the tasks.</p>
<p>I was amazed on how easy it was to integrate celery with django. I just created a few tasks to
actually crawl blogs (I already had the code from my last post) and create some
<a href="https://docs.djangoproject.com/en/dev/ref/contrib/admin/actions/">django actions</a> so the I can create
tasks by demand.</p>
<h2>Tasks</h2>
<p>The <code>tasks.py</code> is below. Depending on if the blog is wordpress or blogspot I crawl the blog feed
differently, that way I can crawl not only the 10 most recent posts but the whole blog. So I created a few tasks
to discover the type of the blog. Then based on the type discover the feed URL to crawl.</p>
<p>For example wordpress blogs generally have the feed under: <code>http://mywordpressblog.com/feed/</code>.
This gives me only 10 posts if I want more I can request: <code>http://mywordpressblog.com/feed/?paged=2</code>
and that will give me a feed from post 11 to 20. Do this recursively and you get all the posts of the blog.
Something similar happens with blogspot.</p>
<p>Finally I created some simple tasks to convert the post content to lower-case and word-tokenization using
a new but pretty amazing library called <a href="https://github.com/sloria/TextBlob">TextBlob</a></p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">apps.blog_crawler</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">apps.blog_crawler.models</span> <span class="kn">import</span> <span class="n">Blog</span><span class="p">,</span> <span class="n">Post</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">readability</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">from</span> <span class="nn">text.blob</span> <span class="kn">import</span> <span class="n">TextBlob</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">lowerize</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>

    <span class="n">post</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">cleaned</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">word_tokenize</span><span class="p">(</span><span class="n">post_id</span><span class="p">):</span>
    <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">post_id</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">cleaned</span><span class="p">)</span>

    <span class="n">post</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">words</span><span class="p">)</span>
    <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">discover_type</span><span class="p">(</span><span class="n">blog_id</span><span class="p">):</span>
    <span class="n">blog</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">blog_id</span><span class="p">)</span>

    <span class="n">kind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">discover_kind</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">blog</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">blog</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">discover_feed</span><span class="p">(</span><span class="n">blog_id</span><span class="p">):</span>
    <span class="n">blog</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">blog_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">blog</span><span class="o">.</span><span class="n">kind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">discover_kind</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
        <span class="n">blog</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">discover_feed</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">blog</span><span class="o">.</span><span class="n">kind</span><span class="p">)</span>
    <span class="n">blog</span><span class="o">.</span><span class="n">feed</span> <span class="o">=</span> <span class="n">feed</span>
    <span class="n">blog</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>


<span class="nd">@task</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="n">blog_id</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">blog</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">blog_id</span><span class="p">)</span>

    <span class="c1"># Readability API</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">readability</span><span class="o">.</span><span class="n">ParserClient</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">READABILITY_PARSER_TOKEN</span><span class="p">)</span>

    <span class="c1"># Create and start logger</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">create_logger</span><span class="p">(</span><span class="n">urllib</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">))</span>

    <span class="n">post_list</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">get_posts</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">feed</span><span class="p">,</span> <span class="n">blog</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limit</span><span class="p">)</span>
    <span class="n">n_posts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_list</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{0} ({1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">))</span>

    <span class="c1"># Start actual crawl</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">post_list</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Post</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{0}/{1} Already exists: {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parser_response</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_article_content</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">parser_response</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>
                <span class="n">content</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="n">strip</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">post</span> <span class="o">=</span> <span class="n">Post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">date</span><span class="o">=</span><span class="n">date</span><span class="p">)</span>
                <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{0}/{1} FAIL: {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{0}/{1} OK: {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_posts</span><span class="p">,</span> <span class="n">url</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">3.6</span><span class="p">)</span>
</pre></div>


<h2>Django Admin</h2>
<p>Then just needed to create a django app with some actions to call the celery tasks. This allows me to have the
worker on a micro instance on EC2 and just queue the tasks using celery.
I used <a href="http://www.rabbitmq.com/">rabbitmq</a> as the broker.</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Blog</span><span class="p">,</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">apps.blog_crawler</span> <span class="kn">import</span> <span class="n">tasks</span>


<span class="k">class</span> <span class="nc">BlogAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;kind&#39;</span><span class="p">,</span> <span class="s1">&#39;feed&#39;</span><span class="p">,</span> <span class="s1">&#39;last_crawl&#39;</span><span class="p">]</span>
    <span class="n">ordering</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;discover_type&#39;</span><span class="p">,</span> <span class="s1">&#39;discover_feed&#39;</span><span class="p">,</span> <span class="s1">&#39;crawl&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">discover_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">discover_type</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Task(s) created&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">discover_feed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">discover_feed</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Task(s) created&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">crawl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">crawl</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">blog</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Task(s) created&#39;</span><span class="p">)</span>

    <span class="n">discover_type</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Discover the type of the blog(s)&#39;</span>
    <span class="n">discover_feed</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Discover the feed of the blog(s)&#39;</span>
    <span class="n">crawl</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Crawls the selected blog(s)&#39;</span>


<span class="k">class</span> <span class="nc">PostAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">,</span> <span class="s1">&#39;date&#39;</span><span class="p">]</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="s1">&#39;word_tokenize&#39;</span><span class="p">,</span> <span class="s1">&#39;lowerize&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">post</span><span class="o">.</span><span class="n">cleaned</span> <span class="o">=</span> <span class="n">post</span><span class="o">.</span><span class="n">content</span>
            <span class="n">post</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Content copied&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">word_tokenize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">word_tokenize</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Task(s) created&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lowerize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">post</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">lowerize</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">post</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message_user</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Task(s) created&#39;</span><span class="p">)</span>

    <span class="n">copy</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Copy the crawled content to cleaned&#39;</span>
    <span class="n">word_tokenize</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Tockenize by words&#39;</span>
    <span class="n">lowerize</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;Lower-case the cleaned content&#39;</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Blog</span><span class="p">,</span> <span class="n">BlogAdmin</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">PostAdmin</span><span class="p">)</span>
</pre></div>


<h2>UI</h2>
<p>The admin UI, using the <a href="http://djangosuit.com/">beautiful django suit</a>, looks like this.</p>
<p>{% b64img articles/2013/09/django-crawler/home_admin.png "Home admin" %}</p>
<p>Note: don't ask me why is I am using that blog to test</p>
<p>{% b64img articles/2013/09/django-crawler/blogs_admin.png "Blogs admin" %}</p>
<p>{% b64img articles/2013/09/django-crawler/posts_admin.png "Posts admin" %}</p>
<p>You can see the running tasks, or previous tasks.</p>
<p>{% b64img articles/2013/09/django-crawler/tasks.png "Tasks" %}</p>
<h2>Conclusion</h2>
<p>I was pretty happy with this result. With very little effort I was able to build a quite complex
system. PostgreSQL for the database, rabbitmq + celery for message/tasks queuing and finally
Django for the UI. I can even create some</p>
<p>I consider this an example of why I choose python and its amazing community. The people working on
these projects are brilliant and are doing an amazing job. Focusing on building the basic tools so
people can build amazing stuff faster and easier than ever.</p>
<p>Some stuff I want to try next if real live allows me to is:</p>
<ul>
<li><a href="http://haystacksearch.org/">Haystack</a> + Solr for search</li>
<li>MongoDB instead of Postgres. Apparently is <em>really</em> easy using <a href="https://github.com/django-nonrel/mongodb-engine">django-nonrel</a></li>
</ul>
<p>As usual everything is on github: <a href="https://github.com/danielfrg/django_crawler">django-crawler</a></p>
        </div>

        <div class="meta">
            <div>
                    <a href="https://blog.vipings.com/tag/python.html" class="tag">πython</a>
                    <a href="https://blog.vipings.com/tag/django.html" class="tag">Django</a>
                    <a href="https://blog.vipings.com/tag/celery.html" class="tag">Celery</a>
                    <a href="https://blog.vipings.com/tag/readability.html" class="tag">Readability</a>
                    <a href="https://blog.vipings.com/tag/crawling.html" class="tag">Crawling</a>
            </div>
        </div>
    </article>
</div>

<style type="text/css">
{
    max-width: 700px;
}

.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
    max-width: 580px;
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}

table.dataframe th, td {
    padding: 4px;
    text-align: left;
}

pre code {
    background-color: inherit;
}</style>

        </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35523657-2', 'danielfrg.com');
  ga('send', 'pageview');

</script>

    </body>
</html>