<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="author" content="Vipin G S">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">
        <title>Multicorn in Docker + conda for Postgres Foreign Data Wrappers in Python | EssentialDataScience</title>

        <link rel="alternate" type="application/atom+xml" title="EssentialDataScience blog atom feed" href="/feeds/all.atom.xml" />
        <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <style>.codehilite .hll { background-color: #404040 }
.codehilite .c { color: #999999; font-style: italic } /* Comment */
.codehilite .err { color: #a61717; background-color: #e3d2d2 } /* Error */
.codehilite .g { color: #d0d0d0 } /* Generic */
.codehilite .k { color: #6ab825; font-weight: bold } /* Keyword */
.codehilite .l { color: #d0d0d0 } /* Literal */
.codehilite .n { color: #d0d0d0 } /* Name */
.codehilite .o { color: #d0d0d0 } /* Operator */
.codehilite .x { color: #d0d0d0 } /* Other */
.codehilite .p { color: #d0d0d0 } /* Punctuation */
.codehilite .cm { color: #999999; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #cd2828; font-weight: bold } /* Comment.Preproc */
.codehilite .c1 { color: #999999; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #e50808; font-weight: bold; background-color: #520000 } /* Comment.Special */
.codehilite .gd { color: #d22323 } /* Generic.Deleted */
.codehilite .ge { color: #d0d0d0; font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #d22323 } /* Generic.Error */
.codehilite .gh { color: #ffffff; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #589819 } /* Generic.Inserted */
.codehilite .go { color: #cccccc } /* Generic.Output */
.codehilite .gp { color: #aaaaaa } /* Generic.Prompt */
.codehilite .gs { color: #d0d0d0; font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #ffffff; text-decoration: underline } /* Generic.Subheading */
.codehilite .gt { color: #d22323 } /* Generic.Traceback */
.codehilite .kc { color: #6ab825; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #6ab825; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #6ab825; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #6ab825 } /* Keyword.Pseudo */
.codehilite .kr { color: #6ab825; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #6ab825; font-weight: bold } /* Keyword.Type */
.codehilite .ld { color: #d0d0d0 } /* Literal.Date */
.codehilite .m { color: #3677a9 } /* Literal.Number */
.codehilite .s { color: #ed9d13 } /* Literal.String */
.codehilite .na { color: #bbbbbb } /* Name.Attribute */
.codehilite .nb { color: #24909d } /* Name.Builtin */
.codehilite .nc { color: #447fcf; text-decoration: underline } /* Name.Class */
.codehilite .no { color: #40ffff } /* Name.Constant */
.codehilite .nd { color: #ffa500 } /* Name.Decorator */
.codehilite .ni { color: #d0d0d0 } /* Name.Entity */
.codehilite .ne { color: #bbbbbb } /* Name.Exception */
.codehilite .nf { color: #447fcf } /* Name.Function */
.codehilite .nl { color: #d0d0d0 } /* Name.Label */
.codehilite .nn { color: #447fcf; text-decoration: underline } /* Name.Namespace */
.codehilite .nx { color: #d0d0d0 } /* Name.Other */
.codehilite .py { color: #d0d0d0 } /* Name.Property */
.codehilite .nt { color: #6ab825; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #40ffff } /* Name.Variable */
.codehilite .ow { color: #6ab825; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #666666 } /* Text.Whitespace */
.codehilite .mf { color: #3677a9 } /* Literal.Number.Float */
.codehilite .mh { color: #3677a9 } /* Literal.Number.Hex */
.codehilite .mi { color: #3677a9 } /* Literal.Number.Integer */
.codehilite .mo { color: #3677a9 } /* Literal.Number.Oct */
.codehilite .sb { color: #ed9d13 } /* Literal.String.Backtick */
.codehilite .sc { color: #ed9d13 } /* Literal.String.Char */
.codehilite .sd { color: #ed9d13 } /* Literal.String.Doc */
.codehilite .s2 { color: #ed9d13 } /* Literal.String.Double */
.codehilite .se { color: #ed9d13 } /* Literal.String.Escape */
.codehilite .sh { color: #ed9d13 } /* Literal.String.Heredoc */
.codehilite .si { color: #ed9d13 } /* Literal.String.Interpol */
.codehilite .sx { color: #ffa500 } /* Literal.String.Other */
.codehilite .sr { color: #ed9d13 } /* Literal.String.Regex */
.codehilite .s1 { color: #ed9d13 } /* Literal.String.Single */
.codehilite .ss { color: #ed9d13 } /* Literal.String.Symbol */
.codehilite .bp { color: #24909d } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #40ffff } /* Name.Variable.Class */
.codehilite .vg { color: #40ffff } /* Name.Variable.Global */
.codehilite .vi { color: #40ffff } /* Name.Variable.Instance */
.codehilite .il { color: #3677a9 } /* Literal.Number.Integer.Long */</style>
        <style>body{margin:0;padding:0;font:15px 'Source Sans Pro',sans-serif;line-height:1.6em;color:#222;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased}a{color:#007ee5;text-decoration:none}a:hover{color:#007ee5;text-decoration:none}header.main-header{background:none repeat scroll 0% 0% #2A66C0;margin-bottom:0px}header.main-header a{color:#fff}header.main-header .container{max-width:1000px}header.main-header .container nav a:hover{background-color:#2A66C0}article{margin:0}article header{margin-bottom:20px;padding-bottom:20px}article header h1{margin-bottom:2px;font-weight:700;color:#000}article header time{color:#9E9E9E;font-size:0.85em;float:right}article header time.left{color:#9E9E9E;font-size:0.85em;float:left}article p{font-size:16px;margin-bottom:20px;line-height:1.6em}article p.note{background:#f5f5f5;border:1px solid #ddd;padding:0.533em 0.733em}article p.update{background-color:#FEEFB3;border:1px solid #e6e68a;padding:0.533em 0.733em}article p.alert{background-color:#ffe2e2;border:1px solid #ffb2b2;padding:0.533em 0.733em}article ul,article ol{margin-top:0px;margin-bottom:25px}article li{font-size:16px;line-height:1.6em}article a:hover{text-decoration:underline}article blockquote{border-left:2px solid #c7c7cc;color:#666;margin:30px 0;padding:0 0 0 25px}article img{max-width:100%}article code{color:#333;background-color:#EEE;border-radius:0;font-size:13px}article .codehilite pre{border-radius:0;background-color:#202020;color:#d0d0d0}article .codehilite pre code{border:none}article .codehilite pre.bash{background-color:#000;color:#FFF}article .meta{font-size:11px}article .meta a:hover{text-decoration:none}article .meta div{margin-bottom:20px;display:block}article .meta a.tag{margin:0 10px 10px 0;padding:1px 12px;display:inline-block;font-size:12px;color:rgba(0,0,0,0.6);background:rgba(0,0,0,0.05)}article .meta a.tag:hover{background:rgba(0,0,0,0.15)}article .meta a.read_more,article .meta a.comments_btn{font-size:14px;font-weight:800;padding:10px 20px;color:#007EE5;background:#FFF;border:1px solid #007EE5}article .meta a.read_more:hover,article .meta a.comments_btn:hover{color:#FFF;background:#007EE5}.index{max-width:700px}.index article header h2{font-size:36px;margin-bottom:2px;font-weight:700}.index article header h2 a{color:#000}.index article header h2 a:hover{color:#007ee5;text-decoration:none}.index .separator{padding:40px 0 0 0;margin:0 0 40px 0;height:10px;border-bottom:solid 1px #CCC}.index .pagination{display:block;margin-bottom:100px}.index .pagination .left{text-align:right}.index .pagination .right{text-align:left}.index .pagination a{display:inline-block;border:2px solid #007EE5;margin:0 5px;padding:8px 20px;font-weight:bold;color:#007EE5}.index .pagination a:hover{color:#FFF;background:#007EE5}.post{max-width:700px}.post h2:before{content:"# ";font-weight:bold;color:#DDD}.post h3:before{content:"## ";font-weight:bold;color:#DDD}.post h4:before{content:"### ";font-weight:bold;color:#DDD}.post article .meta{margin:50px 0 100px}.list{max-width:700px}.list ul.double-list{margin:0 auto 60px;padding:0;list-style-type:none}.list ul.double-list li{padding:5px 0}.list ul.double-list li h2{font-size:1em;display:inline;font-weight:normal}.list ul.double-list li span{font-family:sans-serif;text-transform:uppercase;text-align:right;float:right;padding-top:3px;font-size:12px;color:#999}.full-width-content{padding-top:10px;padding-left:0px;padding-right:0px;margin-left:-20px;margin-right:-20px}.col-xs-1,.col-sm-1,.col-md-1,.col-lg-1,.col-xs-2,.col-sm-2,.col-md-2,.col-lg-2,.col-xs-3,.col-sm-3,.col-md-3,.col-lg-3,.col-xs-4,.col-sm-4,.col-md-4,.col-lg-4,.col-xs-5,.col-sm-5,.col-md-5,.col-lg-5,.col-xs-6,.col-sm-6,.col-md-6,.col-lg-6,.col-xs-7,.col-sm-7,.col-md-7,.col-lg-7,.col-xs-8,.col-sm-8,.col-md-8,.col-lg-8,.col-xs-9,.col-sm-9,.col-md-9,.col-lg-9,.col-xs-10,.col-sm-10,.col-md-10,.col-lg-10,.col-xs-11,.col-sm-11,.col-md-11,.col-lg-11,.col-xs-12,.col-sm-12,.col-md-12,.col-lg-12{padding-right:0px;padding-left:0px}</style>

    </head>

    <body>
        <header class="navbar navbar-static-top bs-docs-nav main-header">
            <div class="container">
                <div class="navbar-header">
                    <a class="navbar-brand" href="/" title="Home" class="title">Daniel Rodriguez</a></li>
                </div>
                <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                    <ul class="nav navbar-nav navbar-right">
                            <li><a href="/pages/about.html" title="About">About</a></li>
                            <li><a href="http://github.com/vipings" title="vipings's Github" rel="me">Github</a></li>
                            <li><a href="http://twitter.com/vipingsnair" title="vipingsnair Twitter" rel="me">Twitter</a></li>
                            <li><a href="/archives.html" title="Archive">Archive</a></li>
                            <li><a href="/feeds/all.atom.xml" title="danielfrg.github.io RSS feed" rel="me">RSS</a></li>
                    </ul>
                </nav>
            </div>
        </header>

        <div id="wrap">
<div class="container post">
    <article>
        <header>
            <h1>Multicorn in Docker + conda for Postgres Foreign Data Wrappers in Python</h1>
            <time datetime="article.date.isoformat()" pubdate>October 06, 2015</time>
        </header>

        <div class="article_content">
            <p><a href="http://multicorn.org/">Multicorn</a> is (in my opinion) one of those hidden gems in the python community.
It is basically a wrapper for <a href="https://wiki.postgresql.org/wiki/Foreign_data_wrappers">Postgres Foreign data wrappers</a>
and it makes it really easy to develop one in python.
What that means is that it allows to use what is probably the most common and used database right now,
Postgres, as a frontend for sql queries while allowing to use different data storage and even computation.</p>
<p>Unfortunately its not really known and therefore used, the only real example I have been impress
with is a talk by Ville Tuulos: <a href="https://www.youtube.com/watch?v=xnfnv6WT1Ng">How to Build a SQL-based Data Warehouse for 100+ Billion Rows in Python</a>
where he talks about how AdRoll <em>"built a custom, high-performance data warehouse in Python which
can handle hundreds of billions of data points with sub-minute latency on a small cluster of servers"</em>.</p>
<p>That talk is a only a year old but to be honest the first time I saw it and tried to use Multicorn it was a complete failure.
Fortunately things have improved and now also we have Docker and conda.
I was really curious if it was still difficult to combine these two to make a simple Pandas FDW.
Basically use pandas to read a CSV and filter using Pandas instead of Postgres.</p>
<p>There are a couple of Multicorn docker container in Docker Hub but I decided to do my own specially
because the ones I found were not based on the Postgres docker container.
Dockerfile can be found in <a href="https://github.com/danielfrg/docker-multicorn">Github: docker-multicorn</a>
or the image can be just pulled by doing <code>docker pull danielfrg/multicorn</code>.</p>
<p>When started the container will install any python library on <code>/src</code> since this is required for Multicorn to use the custom FDW.</p>
<p>It also includes a couple of examples on how to use the image.</p>
<h2>Simple CSV</h2>
<p>This example is basically a copy of one of Multicorn examples
where they just load a <code>csv</code> file using just the python std-library I just use the iris dataset here.</p>
<div class="codehilite">
<pre class="bash">
$ docker run -p 5432:5432 -v $(pwd):/src multicorn
</div>

</pre>

<p>Connect to the Database (using pgadmin for example) create the FDW and Foreign table.</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">multicorn</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="n">SERVER</span> <span class="n">csv_srv</span> <span class="k">foreign</span> <span class="k">data</span> <span class="n">wrapper</span> <span class="n">multicorn</span> <span class="k">options</span> <span class="p">(</span>
    <span class="n">wrapper</span> <span class="s1">&#39;multicorn.csvfdw.CsvFdw&#39;</span>
<span class="p">);</span>

<span class="k">create</span> <span class="k">foreign</span> <span class="k">table</span> <span class="n">csvtest</span> <span class="p">(</span>
      <span class="n">sepal_length</span> <span class="nb">numeric</span><span class="p">,</span>
      <span class="n">sepal_width</span> <span class="nb">numeric</span><span class="p">,</span>
      <span class="n">petal_length</span> <span class="nb">numeric</span><span class="p">,</span>
      <span class="n">petal_width</span> <span class="nb">numeric</span><span class="p">,</span>
      <span class="n">species</span> <span class="nb">character</span> <span class="nb">varying</span>
<span class="p">)</span> <span class="n">server</span> <span class="n">csv_srv</span> <span class="k">options</span> <span class="p">(</span>
      <span class="n">filename</span> <span class="s1">&#39;/src/iris.csv&#39;</span><span class="p">,</span>
      <span class="n">skip_header</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span>
      <span class="k">delimiter</span> <span class="s1">&#39;,&#39;</span>
<span class="p">);</span>
</pre></div>


<p>Now is possible to make SQL queries to the table.</p>
<div class="highlight"><pre><span></span><span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">csvtest</span><span class="p">;</span>
<span class="k">select</span> <span class="n">sepal_width</span> <span class="k">from</span> <span class="n">csvtest</span><span class="p">;</span>
</pre></div>


<h2>Pandas</h2>
<p>That simple example shows what is possible but is very useless. In Ville Tuulos talk he uses Numba
to make some computation, the easiest way to use Numba is to using conda so the docker container
also includes conda so you can create a custom container with the extra packages needed.
In this case I am just using pandas.</p>
<p>The code for the pandas FDW could not be simpler:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multicorn</span> <span class="kn">import</span> <span class="n">ForeignDataWrapper</span>
<span class="kn">from</span> <span class="nn">multicorn.utils</span> <span class="kn">import</span> <span class="n">log_to_postgres</span>


<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>


<span class="k">class</span> <span class="nc">PandasForeignDataWrapper</span><span class="p">(</span><span class="n">ForeignDataWrapper</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PandasForeignDataWrapper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">columns</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">columns</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">quals</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
        <span class="n">log_to_postgres</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;python&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">qual</span> <span class="ow">in</span> <span class="n">quals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">qual</span><span class="o">.</span><span class="n">operator</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">qual</span><span class="o">.</span><span class="n">field_name</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">qual</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
</pre></div>


<p>Basically:</p>
<ol>
<li>Importing <code>multicorn.ForeignDataWrapper</code> and <code>pandas</code></li>
<li>Extend a <code>ForeignDataWrapper</code> class</li>
<li>Define an <code>execute</code> method that does the load/computation</li>
<li>Implement (or not, see below) the filtering of columns and rows. The <code>quals</code> has <code>.field</code> <code>.operator</code> ('&lt;', '&gt;=', and so on) and a <code>.value</code></li>
<li>Yield a dictionary with the columns as keys and values as values</li>
</ol>
<p>With the code ready just need to build a custom container with my requirements.</p>
<div class="highlight"><pre><span></span><span class="k">FROM</span><span class="s"> multicorn</span>
<span class="k">RUN</span> conda install -y pandas
</pre></div>


<p>Now build that image run the container in the same way as the previous one.</p>
<div class="codehilite">
<pre class="bash">
$ docker build -t pandasfdw .
$ docker run -p 5432:5432 -v $(pwd):/src pandasfdw
</div>

</pre>

<p>Create the FDW and table in a similar way as before:</p>
<div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="n">EXTENSION</span> <span class="n">multicorn</span><span class="p">;</span>

<span class="k">CREATE</span> <span class="n">SERVER</span> <span class="n">pandas_srv</span> <span class="k">foreign</span> <span class="k">data</span> <span class="n">wrapper</span> <span class="n">multicorn</span> <span class="k">options</span> <span class="p">(</span>
    <span class="n">wrapper</span> <span class="s1">&#39;pandasfdw.PandasForeignDataWrapper&#39;</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">FOREIGN</span> <span class="k">TABLE</span> <span class="n">pandastable</span> <span class="p">(</span>
    <span class="n">sepal_length</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">sepal_width</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">petal_length</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">petal_width</span> <span class="nb">numeric</span><span class="p">,</span>
    <span class="n">species</span> <span class="nb">character</span> <span class="nb">varying</span>
<span class="p">)</span> <span class="n">server</span> <span class="n">pandas_srv</span> <span class="k">options</span><span class="p">(</span>
    <span class="n">filename</span> <span class="s1">&#39;/src/iris.csv&#39;</span>
<span class="p">);</span>
</pre></div>


<p>Now you can query the table and since we implemented the less than operation we can do:</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">pandastable</span> <span class="k">where</span> <span class="n">sepal_width</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
</pre></div>


<div class="highlight"><pre><span></span>sepal_length,sepal_width,petal_length,petal_width,species
4.5;2.3;1.3;0.3;&quot;setosa&quot;
5.5;2.3;4.0;1.3;&quot;versicolor&quot;
4.9;2.4;3.3;1.0;&quot;versicolor&quot;
5.0;2.0;3.5;1.0;&quot;versicolor&quot;
6.0;2.2;4.0;1.0;&quot;versicolor&quot;
6.2;2.2;4.5;1.5;&quot;versicolor&quot;
5.5;2.4;3.8;1.1;&quot;versicolor&quot;
5.5;2.4;3.7;1.0;&quot;versicolor&quot;
6.3;2.3;4.4;1.3;&quot;versicolor&quot;
5.0;2.3;3.3;1.0;&quot;versicolor&quot;
6.0;2.2;5.0;1.5;&quot;virginica&quot;
</pre></div>


<p>What if we do a greater than now?, we don't have that implemented.</p>
<div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">from</span> <span class="n">pandastable</span> <span class="k">where</span> <span class="n">sepal_width</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="p">;</span>
</pre></div>


<div class="highlight"><pre><span></span>sepal_length,sepal_width,petal_length,petal_width,species
5.1;3.5;1.4;0.2;&quot;setosa&quot;
4.9;3.0;1.4;0.2;&quot;setosa&quot;
4.7;3.2;1.3;0.2;&quot;setosa&quot;
4.6;3.1;1.5;0.2;&quot;setosa&quot;
5.0;3.6;1.4;0.2;&quot;setosa&quot;
5.4;3.9;1.7;0.4;&quot;setosa&quot;
4.6;3.4;1.4;0.3;&quot;setosa&quot;
5.0;3.4;1.5;0.2;&quot;setosa&quot;
</pre></div>


<p>Answer is still correct! That is because Postgres will check the conditions anyways but
if we want we can do that in the custom FDW and pass only the values we want to postgres.</p>
<h2>Thoughts</h2>
<p>This time it was really straight forward to create the Multicorn container and make simple example using pandas.</p>
<p>That code is far (way far) from being useful. For example is reading the CSV file every query (<code>execute</code>).
It should be possible to load in the <code>__init__</code> and use that <code>df</code> in the query as shown in one of Multicorn's examples: <a href="https://github.com/Kozea/Multicorn/blob/master/python/multicorn/statefdw.py">statefdw.py</a>.</p>
<p>I am not sure why Multicorn and this method is not more wildly used.
One simple idea in my mind is for example: for one of the million SQL-on-Hadoop engines that are
now why not make a simple FDW that sends the information to a that engine.
It would make it much easier for multiple application in multiple languages to just query Postgres
(<code>Psycopg2</code> in python) rather than have custom libraries in multiple languages with different features on each one.
It would also probably make custom DSLs like blaze and ibis target more backends easier.</p>
<p>For that particular example I can thing a couple of reason why not to use Multicorn.
For example you cannot do some operations in the Custom FDW:
a <code>group by</code> gets executed by Postgres using the data passed back from the FDW.
Also each SQL engine has its own characteristics, features and DLL and being constrain to Postgres
is probably not an option on those cases.</p>
<p>Another simple idea would be to have multiple services (maybe with a ZMQ API) and having postgres making
the requests to those services, that way the clients can just query Postgres as an universal SQL entrypoint.</p>
        </div>

        <div class="meta">
            <div>
                    <a href="https://blog.vipings.com/tag/postgres.html" class="tag">Postgres</a>
                    <a href="https://blog.vipings.com/tag/multicorn.html" class="tag">Multicorn</a>
                    <a href="https://blog.vipings.com/tag/python.html" class="tag">Python</a>
                    <a href="https://blog.vipings.com/tag/conda.html" class="tag">Conda</a>
                    <a href="https://blog.vipings.com/tag/docker.html" class="tag">Docker</a>
            </div>
        </div>
    </article>
</div>

<style type="text/css">
{
    max-width: 700px;
}

.text_cell .prompt {
    display: none;
}

div.cell {
    padding: 0;
}

div.text_cell_render {
    padding: 0;
}

div.prompt {
    font-size: 13px;
}

div.input_prompt {
    padding: .7em 0.2em;
}

div.output_prompt {
    padding: .4em .2em;
}

div.input_area {
    margin: .2em 0.4em;
    max-width: 580px;
}

table.dataframe {
    font-family: Arial, sans-serif;
    font-size: 13px;
    line-height: 20px;
}

table.dataframe th, td {
    padding: 4px;
    text-align: left;
}

pre code {
    background-color: inherit;
}</style>

        </div>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-35523657-2', 'danielfrg.com');
  ga('send', 'pageview');

</script>

    </body>
</html>